<!DOCTYPE html>
<html>
<head>
    <title>XYZZY - Friends Against Humanity</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: 'Helvetica', sans-serif; background: #111; color: white; text-align: center; margin: 0; padding: 20px; }
        .card { width: 150px; height: 210px; padding: 15px; border-radius: 12px; background-size: 100% 100%; display: inline-block; margin: 8px; text-align: left; font-weight: bold; color: black; cursor: pointer; border: 1px solid #333; vertical-align: top; overflow: hidden; line-height: 1.2; }
        .black-card { background-image: url('blkcard.png'); color: white; cursor: default; }
        .white-card { background-image: url('whitecard.png'); }
        .score-board { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.9); padding: 15px; border: 1px solid #444; border-radius: 8px; z-index: 100; text-align: left; font-size: 14px; }
        #login-box { margin-top: 15vh; border: 1px solid #333; display: inline-block; padding: 40px; border-radius: 15px; background: #1a1a1a; }
        .status-msg { color: #ffcc00; margin: 15px; font-weight: bold; }
        .admin-link { display: block; margin-top: 20px; color: #555; font-size: 12px; cursor: pointer; text-decoration: underline; }
        hr { border: 0; height: 1px; background: #333; margin: 30px 0; }
        .czar-banner { background: #00ff00; color: black; padding: 5px; font-weight: bold; margin-bottom: 15px; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div id="login-box">
            <h1>FAH Online</h1>
            <div id="lobby-count" class="status-msg">Players in lobby: 0/3</div>
            <input type="text" id="username" placeholder="Nickname" style="padding:10px; border-radius:5px; border:none; width: 200px;"><br><br>
            <button onclick="join()" style="padding:10px 30px; border-radius:5px; border:none; background:white; color:black; font-weight:bold; cursor:pointer;">Enter Lobby</button>
            <span class="admin-link" onclick="adminReset()">Admin Game Reset</span>
        </div>
    </div>

    <div id="game-screen" style="display:none">
        <div class="score-board">
            <div id="scores"></div>
            <button onclick="adminReset()" style="margin-top:10px; background:none; color:red; border:1px solid red; cursor:pointer; width:100%; font-size:10px;">RESET ALL</button>
        </div>

        <div id="waiting-area" style="margin-top: 100px;">
            <h2 id="wait-msg">Waiting for 3 players to start...</h2>
        </div>

        <div id="active-game" style="display:none">
            <div id="is-czar-banner" class="czar-banner" style="display:none">YOU ARE THE CARD CZAR</div>
            
            <h2>Black Card</h2>
            <div id="black-card-display"></div>
            
            <hr>
            <h3>Table (Played Cards)</h3>
            <div id="table-display"></div>
            
            <hr>
            <h3>Your Hand</h3>
            <div id="hand-display"></div>
        </div>
    </div>

    <script>
        const socket = io();
        let myId = "";

        function join() {
            const name = document.getElementById('username').value;
            if(!name) return alert("Please enter a nickname.");
            socket.emit('join-game', name);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
        }

        socket.on('game-state', (data) => {
            myId = socket.id;
            const me = data.players.find(p => p.id === myId);
            
            // Update Login Counter
            document.getElementById('lobby-count').innerText = `Players in lobby: ${data.players.length}/3`;

            if (!me) return;

            // Handle Lobby vs Game state
            if (!data.gameStarted) {
                document.getElementById('waiting-area').style.display = 'block';
                document.getElementById('active-game').style.display = 'none';
                document.getElementById('wait-msg').innerText = `Need ${Math.max(0, 3 - data.players.length)} more player(s) to start...`;
                return;
            }

            document.getElementById('waiting-area').style.display = 'none';
            document.getElementById('active-game').style.display = 'block';

            // Update Scores
            document.getElementById('scores').innerHTML = "<strong>Scores</strong><br>" + 
                data.players.map(p => `${p.isCzar ? 'ðŸ‘‘ ' : ''}${p.username}: ${p.score}`).join('<br>');

            // Czar UI
            document.getElementById('is-czar-banner').style.display = me.isCzar ? 'block' : 'none';

            // Black Card
            document.getElementById('black-card-display').innerHTML = `<div class="card black-card">${data.blackCard}</div>`;

            // Hand (10 cards)
            const handHtml = me.hand.map(card => {
                const safeCard = card.replace(/'/g, "\\'");
                return `<div class="card white-card" onclick="socket.emit('play-card', '${safeCard}')">${card}</div>`;
            }).join('');
            document.getElementById('hand-display').innerHTML = handHtml;

            // Table Submissions
            const tableHtml = data.submissions.map(s => {
                const action = me.isCzar ? `onclick="socket.emit('pick-winner', '${s.playerId}')"` : "";
                // Czar sees text, others see hidden cards
                const content = me.isCzar ? s.card : "???";
                return `<div class="card white-card" ${action}>${content}</div>`;
            }).join('');
            document.getElementById('table-display').innerHTML = tableHtml || "<i>No cards played yet this round.</i>";
        });

        function adminReset() {
            const p = prompt("Admin Password:");
            if(p) socket.emit('reset-game', p);
        }

        socket.on('force-reload', () => location.reload());
        socket.on('error-msg', (msg) => alert(msg));
    </script>
</body>
</html>
