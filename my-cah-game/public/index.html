<!DOCTYPE html>
<html>
<head>
    <title>CardsAgainstTheLCU</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Arial Black', sans-serif; background: #111; color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #layout { display: flex; flex: 1; overflow: hidden; position: relative; z-index: 1; }
        #game-view { flex: 1; display: flex; flex-direction: column; background: #151515; position: relative; }
        #sidebar { width: 300px; background: #1a1a1a; border-left: 2px solid #333; display: flex; flex-direction: column; z-index: 2; }

        /* RED ADMIN BUTTON */
        #admin-trigger { position: fixed; bottom: 20px; left: 20px; background: red; color: white; padding: 10px 15px; font-weight: bold; border: 2px solid white; border-radius: 8px; cursor: pointer; z-index: 999999; text-transform: uppercase; }
        #admin-panel { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; border: 3px solid cyan; padding: 20px; z-index: 1000000; display: none; text-align: center; min-width: 250px; }

        /* LOGIN */
        #login { position: fixed; inset: 0; background: #111; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100000; }

        /* CARDS */
        .card { flex: 0 0 auto; width: 140px; height: 190px; padding: 12px; margin: 5px; border-radius: 10px; text-align: left; font-size: 14px; border: 4px solid transparent; background-size: 100% 100%; color: black; }
        .black { background-image: url('blkcard.png'); color: white; }
        .white { background-image: url('whitecard.png'); cursor: pointer; }
        .selected { border-color: cyan !important; transform: translateY(-10px); }

        #hand-wrapper { background: #222; border-top: 2px solid #444; padding: 10px; }
        #hand { display: flex; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        
        .btn { padding: 12px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; width: 100%; }
        .confirm-btn { background: cyan; color: black; width: 90%; max-width: 300px; margin: 10px auto; display: none; }
        #winner-overlay { display: none; position: fixed; inset: 0; z-index: 9000; background: rgba(0,0,0,0.95); align-items: center; justify-content: center; color: cyan; font-size: 2em; }
    </style>
</head>
<body>
    <div id="winner-overlay"></div>
    <div id="admin-trigger" onclick="tryAdmin()">üõ† ADMIN</div>
    <div id="admin-panel">
        <h3 style="color:cyan;">ADMIN CONTROLS</h3>
        <button class="btn" onclick="admin('toggle-bot')">ü§ñ Toggle Bots</button>
        <button class="btn" onclick="admin('toggle-debug')">üìü Toggle Debug</button>
        <button class="btn" onclick="admin('wipe-chat')" style="background:red; color:white;">‚ùå Wipe Chat</button>
        <button class="btn" onclick="admin('reset')" style="background:orange;">üîÑ Reset Game</button>
        <button class="btn" onclick="document.getElementById('admin-panel').style.display='none'">Close</button>
    </div>

    <div id="login">
        <img src="cardsback.png" style="width:200px; margin-bottom:20px;">
        <input type="text" id="nick" placeholder="Username" style="padding:15px; width:250px; text-align:center;"><br>
        <button class="btn" onclick="join()" style="background:cyan;">JOIN GAME</button>
    </div>

    <div id="layout">
        <div id="game-view">
            <div style="background:#000; padding:10px; border-bottom:1px solid cyan; text-align:center;">
                üëë CZAR: <span id="czar-name" style="color:cyan">...</span>
            </div>
            <div id="play-area" style="flex:1; overflow-y:auto; padding:10px; text-align:center;">
                <div id="black-area"></div>
                <div id="mat"></div>
            </div>
            <button id="sub-btn" class="confirm-btn" onclick="confirmChoice()">CONFIRM SELECTION</button>
            <div id="hand-wrapper"><div id="hand"></div></div>
        </div>
        <div id="sidebar">
            <div id="chat-area" style="flex:1; overflow-y:auto; padding:10px; font-size:14px;"></div>
            <div style="padding:10px; display:flex; background:#222;">
                <input type="text" id="chat-msg" style="flex:1; padding:10px;">
                <button onclick="sendChat()" class="btn" style="width:auto; background:cyan;">></button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentHand = []; let selIdx = -1; let amICzar = false; let adminPw = "";

        function tryAdmin() { if(!adminPw) adminPw = prompt("Pass?"); if(adminPw) socket.emit('admin-action', { type: 'login', pw: adminPw }); }
        function admin(type) { socket.emit('admin-action', { type, pw: adminPw }); }
        socket.on('admin-success', () => { document.getElementById('admin-panel').style.display='block'; });
        socket.on('admin-fail', () => { alert("Wrong Password"); adminPw = ""; });

        function join() { const n = document.getElementById('nick').value; if(n) { socket.emit('join-game', n); document.getElementById('login').style.display='none'; } }

        socket.on('game-state', (data) => {
            const me = data.players.find(p => p.id === socket.id);
            if(!me) return;
            amICzar = me.isCzar;
            currentHand = me.hand;
            document.getElementById('czar-name').innerText = data.czarName;

            if(!data.gameStarted) { document.getElementById('black-area').innerHTML = "<h2>Wait for 3 players...</h2>"; return; }

            document.getElementById('black-area').innerHTML = `<div class="card black">${data.blackCard}</div>`;
            document.getElementById('hand-wrapper').style.display = (amICzar || me.hasSubmitted) ? 'none' : 'block';
            
            const allDone = data.submissions.length >= (data.players.length - 1);
            document.getElementById('mat').innerHTML = `<h4>Table</h4>` + data.submissions.map(s => {
                return `<div class="card white" ${ (amICzar && allDone) ? `onclick="socket.emit('pick-winner', '${s.playerId}')"` : ""}>${(amICzar && allDone) ? s.card : "???"}</div>`;
            }).join('');

            if(!amICzar && !me.hasSubmitted) {
                document.getElementById('hand').innerHTML = currentHand.map((c, i) => `<div class="card white ${selIdx===i?'selected':''}" onclick="sel(${i})">${c}</div>`).join('');
            } else { document.getElementById('hand').innerHTML = ""; }
        });

        function sel(i) { selIdx = i; document.getElementById('sub-btn').style.display = 'block'; }
        function confirmChoice() { if(selIdx > -1) { socket.emit('submit-card', currentHand[selIdx]); selIdx = -1; document.getElementById('sub-btn').style.display = 'none'; } }
        function sendChat() { const i = document.getElementById('chat-msg'); if(i.value) { socket.emit('send-chat', i.value); i.value=''; } }
        socket.on('new-chat', d => { const c = document.getElementById('chat-area'); c.innerHTML += `<div><b>${d.user}:</b> ${d.text}</div>`; c.scrollTop = c.scrollHeight; });
        socket.on('round-winner', d => { const o = document.getElementById('winner-overlay'); o.innerText = d.name.toUpperCase() + " WON!"; o.style.display = 'flex'; setTimeout(() => o.style.display='none', 3000); });
        socket.on('force-reload', () => location.reload());
    </script>
</body>
</html>
