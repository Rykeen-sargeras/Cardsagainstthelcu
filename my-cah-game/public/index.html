<!DOCTYPE html>
<html>
<head>
    <title>CardsAgainstTheLCU</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Arial Black', sans-serif; background: #111; color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #main { flex: 1; display: flex; flex-direction: column; text-align: center; position: relative; }
        
        /* Sidebar & Chat */
        #sidebar { width: 300px; background: #1a1a1a; border-left: 2px solid #333; display: flex; flex-direction: column; }
        #chat-header-img { width: 100%; height: 120px; object-fit: cover; border-bottom: 2px solid cyan; }
        #chat-area { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; text-align: left; }
        
        /* Debug & Admin */
        #debug-box { position: fixed; top: 10px; right: 320px; width: 220px; background: rgba(0,0,0,0.8); border: 1px solid #0f0; color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; display: none; z-index: 100; }
        #admin-panel { position: fixed; bottom: 60px; left: 20px; background: #222; border: 2px solid cyan; padding: 15px; border-radius: 10px; display: none; z-index: 10000; }

        /* Cards */
        .card { width: 140px; height: 200px; padding: 15px; margin: 8px; border-radius: 10px; display: inline-block; text-align: left; font-size: 14px; cursor: pointer; border: 4px solid transparent; background-size: 100% 100%; vertical-align: top; }
        .black { background-image: url('blkcard.png'); color: white; }
        .white { background-image: url('whitecard.png'); color: black; }
        .selected { border-color: cyan; transform: translateY(-10px); }

        #winner-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9000; align-items: center; justify-content: center; font-size: 3em; color: cyan; }
        #login-screen { position: fixed; inset: 0; background: #111; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn { padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 5px; border: none; margin: 5px; }
    </style>
</head>
<body>

    <div id="winner-overlay"></div>
    <div id="debug-box"></div>

    <div id="login-screen">
        <img src="cardsback.png" style="width: 250px; margin-bottom: 20px;">
        <input type="text" id="nick" placeholder="Enter Nickname..." style="padding:15px; width: 250px;"><br>
        <button class="btn" style="background:white;" onclick="join()">JOIN GAME</button>
    </div>

    <div id="admin-panel">
        <h3 style="margin-top:0">ADMIN MENU</h3>
        <button class="btn" onclick="admin('toggle-bot')">Toggle Bot Mode</button>
        <button class="btn" onclick="admin('toggle-debug')">Toggle Debug Box</button>
        <button class="btn" style="background:red; color:white;" onclick="admin('wipe-chat')">WIPE ALL CHAT</button>
        <button class="btn" onclick="admin('reset')">Reset Game</button>
        <button class="btn" onclick="this.parentElement.style.display='none'">Close</button>
    </div>

    <div id="main">
        <div style="background:#222; padding:10px; border-bottom: 2px solid cyan;">
            ðŸ‘‘ CZAR: <span id="czar-name" style="color:cyan">...</span>
        </div>
        <div id="game-view" style="flex:1; overflow-y:auto; padding:20px;">
            <div id="black-area"></div>
            <div id="mat"></div>
            <hr>
            <div id="hand-area">
                <div id="hand"></div>
                <button id="sub-btn" class="btn" style="display:none; background:cyan;" onclick="sendSubmission()">CONFIRM SUBMISSION</button>
            </div>
        </div>
        <div style="font-size:10px; color:#333; cursor:pointer; text-align:left; padding:5px;" onclick="openAdmin()">Admin</div>
    </div>

    <div id="sidebar">
        <img src="cardsback.png" id="chat-header-img">
        <div id="chat-area"></div>
        <div style="padding:10px; background:#222; display:flex;">
            <input type="text" id="chat-msg" style="flex:1; padding:8px;" placeholder="Message...">
            <button onclick="sendChat()" class="btn" style="margin:0; padding:5px 10px;">></button>
        </div>
    </div>

    <script>
        const socket = io();
        let currentHand = []; let selIdx = -1; let amICzar = false;

        function openAdmin() { if(prompt("Password") === 'Firesluts') document.getElementById('admin-panel').style.display='block'; }
        function admin(type) { socket.emit('admin-action', { type, pw: 'Firesluts' }); }

        function join() {
            const n = document.getElementById('nick').value;
            if(n) { socket.emit('join-game', n); document.getElementById('login-screen').style.display='none'; }
        }

        socket.on('game-state', (data) => {
            const me = data.players.find(p => p.id === socket.id);
            const dbx = document.getElementById('debug-box');
            dbx.style.display = data.debugMode ? 'block' : 'none';
            if(data.debugMode) dbx.innerHTML = `DEBUG<br>Bots: ${data.botMode}<br>Submissions: ${data.submissions.length}`;

            if(!me) return;
            amICzar = me.isCzar;
            currentHand = me.hand;
            document.getElementById('czar-name').innerText = data.czarName;

            if(!data.gameStarted) {
                document.getElementById('black-area').innerHTML = "<h2>Waiting for players...</h2>";
                return;
            }

            if(amICzar && !data.blackCard) {
                document.getElementById('black-area').innerHTML = `<h3>Select a Black Card:</h3>` + 
                    data.czarOptions.map((c, i) => `<div class="card black" onclick="socket.emit('czar-select-black', '${c.replace(/'/g, "\\'")}')">${c}</div>`).join('');
            } else if(data.blackCard) {
                document.getElementById('black-area').innerHTML = `<div class="card black">${data.blackCard}</div>`;
                const allIn = data.submissions.length >= (data.players.length - 1);
                
                document.getElementById('mat').innerHTML = `<h4>The Table</h4>` + data.submissions.map(s => {
                    return `<div class="card white" ${ (amICzar && allIn) ? `onclick="socket.emit('pick-winner', '${s.playerId}')"` : ""}>${(amICzar && allIn) ? s.card : "???"}</div>`;
                }).join('');

                if(!amICzar && !me.hasSubmitted) {
                    document.getElementById('hand').innerHTML = currentHand.map((c, i) => `<div class="card white ${selIdx===i?'selected':''}" onclick="sel(${i})">${c}</div>`).join('');
                } else {
                    document.getElementById('hand').innerHTML = "<i>Please wait...</i>";
                }
            }
        });

        function sel(i) { selIdx = i; document.getElementById('sub-btn').style.display = 'inline-block'; }
        function sendSubmission() { if(selIdx > -1) { socket.emit('submit-card', currentHand[selIdx]); selIdx = -1; document.getElementById('sub-btn').style.display='none'; } }
        
        function sendChat() { const m = document.getElementById('chat-msg'); if(m.value) { socket.emit('send-chat', m.value); m.value=''; } }
        socket.on('new-chat', d => { const c = document.getElementById('chat-area'); c.innerHTML += `<div><b>${d.user}:</b> ${d.text}</div>`; c.scrollTop = c.scrollHeight; });
        socket.on('clear-chat-ui', () => { document.getElementById('chat-area').innerHTML = '<i>Chat wiped by admin.</i>'; });
        
        socket.on('round-winner', d => {
            const o = document.getElementById('winner-overlay');
            o.innerText = d.name + " WON!";
            o.style.display = 'flex';
            if(d.id === socket.id) confetti();
            setTimeout(() => o.style.display = 'none', 3500);
        });
        socket.on('force-reload', () => location.reload());
    </script>
</body>
</html>
